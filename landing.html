<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chess – Choose Side</title>
  <link rel="stylesheet" href="styles.css?v=20250903" />
  <!-- TensorFlow.js so we can show current saved model weights -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  <style>
    .landing-container { max-width:420px; margin:60px auto; background: var(--panel-bg); border:2px solid var(--panel-border); border-radius:12px; padding:32px 36px 40px; font-family:'Roboto',sans-serif; box-shadow:0 6px 18px rgba(0,0,0,.18); }
    .landing-container h1 { margin:0 0 12px; font-size:24px; font-weight:600; text-align:center; color: var(--text-color); }
    .landing-container p { margin:0 0 28px; text-align:center; line-height:1.4; }
    .choose-grid { display:flex; gap:18px; justify-content:center; }
    .side-card { flex:1; min-width:140px; background: linear-gradient(135deg,var(--square-light),var(--history-even)); border:2px solid var(--panel-border); border-radius:10px; padding:14px 12px 16px; display:flex; flex-direction:column; align-items:center; gap:10px; position:relative; transition:.35s box-shadow,.35s transform; cursor:pointer; }
    .side-card:hover { box-shadow:0 4px 10px rgba(0,0,0,.25); transform: translateY(-4px); }
    .side-card.black { background: linear-gradient(135deg,var(--square-dark),#2d1d15); color: var(--square-light); }
    .side-card .label { font-size:18px; font-weight:600; }
    .go-btn { all:unset; cursor:pointer; font-size:14px; padding:8px 16px; background: var(--panel-border); color: var(--square-light); border-radius:6px; font-weight:600; letter-spacing:.5px; box-shadow:0 2px 6px rgba(0,0,0,.25); transition: background .3s, transform .25s; }
    .side-card.black .go-btn { background: var(--square-light); color: var(--square-dark); }
    .go-btn:hover { background: var(--accent-red); transform: translateY(-2px); }
    .note { margin-top:22px; font-size:12px; text-align:center; opacity:.8; }
    .footer-links { margin-top:28px; text-align:center; font-size:12px; }
    .footer-links a { color: var(--accent-red); text-decoration:none; }
  .footer-links a:hover { text-decoration:underline; }
  .time-btn { all:unset; background: var(--square-light); color: var(--square-dark); padding:6px 12px; border:2px solid var(--panel-border); border-radius:6px; font-size:13px; font-weight:600; cursor:pointer; min-width:70px; text-align:center; box-shadow:0 1px 3px rgba(0,0,0,.25); transition:.25s background,.25s transform; }
  .time-btn:hover { background: var(--history-even); transform: translateY(-2px); }
  .time-btn.selected { background: var(--panel-border); color: var(--square-light); box-shadow:0 2px 6px rgba(0,0,0,.3); }
  body.dark .time-btn { background: var(--square-dark); color: var(--square-light); border-color: var(--square-light); }
  body.dark .time-btn.selected { background: var(--square-light); color: var(--square-dark); }
  </style>
</head>
<body>
  <div class="landing-container">
    <h1>Play Chess</h1>
  <p>Select your side and a time control. You're playing against a learning AI that improves as you play.</p>
    <div class="time-select" aria-label="Choose time control" style="margin:0 0 26px;">
      <div style="font-size:14px;font-weight:600;margin:0 0 8px; text-align:center;">Time Control</div>
      <div class="time-options" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;">
        <button type="button" class="time-btn selected" data-mins="0" aria-pressed="true" title="Unlimited / No clock">Unlimited</button>
        <button type="button" class="time-btn" data-mins="1" aria-pressed="false" title="1 minute blitz">1</button>
        <button type="button" class="time-btn" data-mins="3" aria-pressed="false" title="3 minute blitz">3</button>
        <button type="button" class="time-btn" data-mins="5" aria-pressed="false" title="5 minute blitz">5</button>
      </div>
    </div>
    <div class="choose-grid">
      <div class="side-card white" data-color="White" tabindex="0" role="button" aria-label="Play as White">
        <div class="label">White</div>
        <button class="go-btn" type="button">Start →</button>
      </div>
      <div class="side-card black" data-color="Black" tabindex="0" role="button" aria-label="Play as Black">
        <div class="label">Black</div>
        <button class="go-btn" type="button">Start →</button>
      </div>
    </div>
  <div class="note">Note: White moves first. Choosing Black only flips orientation. The AI stores games locally and trains after each result.</div>
    <div class="footer-links"><a href="index.html">Skip (default White)</a></div>
  </div>
  <!-- Model Weights Preview Panel -->
  <div id="landing-weights-panel" aria-label="Current model weights" role="region" style="max-width:420px;margin:26px auto 60px;background:var(--panel-bg);border:2px solid var(--panel-border);border-radius:12px;padding:18px 20px 22px;box-shadow:0 6px 18px rgba(0,0,0,.18);font-family:'Roboto',sans-serif;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:6px;">
      <div style="font-size:18px;font-weight:600;">Model Weights</div>
      <div style="display:flex;gap:6px;">
        <button id="landing-refresh-weights-btn" type="button" class="model-refresh-btn" style="border:none;background:var(--panel-border);color:var(--square-light);padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600;">↻</button>
      </div>
    </div>
    <div id="landing-weights-meta" class="model-meta" style="font-size:12px;opacity:.85;margin-bottom:8px;">Loading model...</div>
    <div class="model-weights-wrapper" style="max-height:260px;overflow:auto;">
      <table class="model-weights" style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead><tr><th style="text-align:left;padding:4px 6px;">Feature</th><th style="text-align:right;padding:4px 6px;">W</th><th style="text-align:right;padding:4px 6px;">Δ</th></tr></thead>
        <tbody id="landing-weight-body"></tbody>
      </table>
    </div>
    <div style="font-size:11px;opacity:.7;margin-top:8px;">Preview of first-layer aggregated magnitudes. Updated from saved local model.</div>
  </div>
  <script>
    (function(){
      const cards = document.querySelectorAll('.side-card');
      function launch(color){
        const sel = document.querySelector('.time-btn.selected');
        const minutes = sel ? parseInt(sel.dataset.mins,10) : 0;
        try {
          localStorage.setItem('playerColor', color);
          localStorage.setItem('timeControlMinutes', String(minutes));
          console.log('[landing] stored playerColor =', color);
          console.log('[landing] stored timeControlMinutes =', minutes);
        } catch(err) { console.warn('localStorage failed', err); }
        window.location.href = 'index.html?side=' + encodeURIComponent(color) + '&tc=' + minutes;
      }
      cards.forEach(card => {
        const color = card.getAttribute('data-color') || 'White';
        const btn = card.querySelector('.go-btn');
        card.addEventListener('click', () => launch(color));
        if (btn) btn.addEventListener('click', e => { e.stopPropagation(); launch(color); });
        card.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); launch(color); }});
      });
      // time control selection
      document.querySelectorAll('.time-btn').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.time-btn').forEach(b=>{ b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
          button.classList.add('selected');
          button.setAttribute('aria-pressed','true');
        });
      });
    })();
  </script>
  <script>
    (function(){
      const features = ['Material','Mobility','KingSafety','CenterControl','PawnStructure','PieceActivity','Pawn','Knight','Bishop','Rook','Queen','King'];
      const tbody = document.getElementById('landing-weight-body');
      if (tbody){
        tbody.innerHTML = features.map(f=>`<tr><td data-f="${f}" style="padding:3px 6px;">${f}</td><td data-w="${f}" style="padding:3px 6px;text-align:right;font-variant-numeric:tabular-nums;">...</td><td data-d="${f}" style="padding:3px 6px;text-align:right;">—</td></tr>`).join('');
      }
      const meta = document.getElementById('landing-weights-meta');
      let model=null; let modelReady=false; let loading=false;
      async function ensureModel(){
        if (modelReady) return model;
        if (typeof tf === 'undefined'){ if (meta) meta.textContent='tf.js not loaded'; return null; }
        loading=true;
        try {
          const flag = localStorage.getItem('tfEngineModelSaved');
          if (flag){
            try { model = await tf.loadLayersModel('indexeddb://tf-chess-eval'); } catch(e){ console.warn('[landing] load failed', e); }
          }
          if (!model){
            model = tf.sequential();
            model.add(tf.layers.dense({inputShape:[773],units:96,activation:'relu'}));
            model.add(tf.layers.dense({units:48,activation:'relu'}));
            model.add(tf.layers.dense({units:1,activation:'tanh'}));
            model.compile({optimizer:'adam',loss:'meanSquaredError'});
            try { await model.save('indexeddb://tf-chess-eval'); localStorage.setItem('tfEngineModelSaved','1'); } catch(_){}
          } else if (!model.optimizer) {
            model.compile({optimizer:'adam',loss:'meanSquaredError'});
          }
          modelReady=true;
          return model;
        } finally { loading=false; }
      }
      function updateWeights(){
        if (!model){ return; }
        const first = model.layers[0]; if (!first){ return; }
        const w = first.getWeights()[0]; if (!w) return;
        const data = w.dataSync(); const inputDim = w.shape[0]; const units = w.shape[1];
        function avgRows(rs,re){ let sum=0,c=0; for (let r=rs;r<re && r<inputDim;r++){ const base=r*units; for (let u=0;u<units;u++){ sum+=Math.abs(data[base+u]); c++; } } return c?sum/c:0; }
        function planeStart(p){ return p*64; } function planeEnd(p){ return p*64+64; }
        function avgPlane(p){ return avgRows(planeStart(p), planeEnd(p)); }
        function combine(planes){ let s=0,c=0; planes.forEach(pl=>{ s+=avgPlane(pl); c++; }); return c? s/c:0; }
        const centerSquares=[27,28,35,36];
        function avgCenterAllPlanes(){ let s=0,c=0; for (let pl=0;pl<12;pl++){ centerSquares.forEach(idx=>{ const row=pl*64+idx; if (row<inputDim){ const base=row*units; for (let u=0;u<units;u++){ s+=Math.abs(data[base+u]); c++; } } }); } return c? s/c:0; }
        const featureValues={
          Material: avgRows(0,768),
          Mobility: combine([1,2,3,4,7,8,9,10]),
          KingSafety: combine([5,11]),
          CenterControl: avgCenterAllPlanes(),
          PawnStructure: combine([0,6]),
          PieceActivity: combine([0,1,2,3,4,6,7,8,9,10]),
          Pawn: combine([0,6]),
          Knight: combine([1,7]),
          Bishop: combine([2,8]),
          Rook: combine([3,9]),
          Queen: combine([4,10]),
          King: combine([5,11])
        };
        // Load previous snapshot for Δ
        let prev = null; try { const raw = localStorage.getItem('tfFeatureSnapshot'); if (raw) prev = JSON.parse(raw); } catch(_){}
        features.forEach(f=>{
          const wtd = tbody && tbody.querySelector(`td[data-w='${f}']`);
          const dtd = tbody && tbody.querySelector(`td[data-d='${f}']`);
          if (wtd && featureValues[f]!=null) wtd.textContent = featureValues[f].toFixed(4);
          if (dtd){
            if (prev && typeof prev[f] === 'number'){
              const d = featureValues[f] - prev[f];
              const s = (d>=0?'+':'') + d.toFixed(4);
              dtd.textContent = s; dtd.style.color = d>0 ? '#2d6a2d' : (d<0 ? '#8c1f1f' : '');
            } else { dtd.textContent = '—'; dtd.style.color=''; }
          }
        });
        if (meta) meta.innerHTML = 'Engine: TFValueNet <span style="opacity:.65;">(saved)</span><br><span class="note">Layer0 avg rows:'+inputDim+' units:'+units+'</span>';
        // Save snapshot so next visit can show Δ
        try { localStorage.setItem('tfFeatureSnapshot', JSON.stringify(featureValues)); } catch(_){}
      }
      async function init(){
        if (meta) meta.textContent='Loading model...';
        await ensureModel();
        if (!model){ if (meta) meta.textContent='Model unavailable'; return; }
        updateWeights();
      }
      init();
      const refreshBtn = document.getElementById('landing-refresh-weights-btn');
      if (refreshBtn){ refreshBtn.addEventListener('click', async ()=>{ if (loading) return; if (meta) meta.textContent='Refreshing...'; await ensureModel(); updateWeights(); }); }
    })();
  </script>
</body>
</html>
